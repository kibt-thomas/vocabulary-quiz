<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcard Language Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        :root {
            --primary-500: #8b5cf6;
            --primary-600: #7c3aed;
            --primary-700: #6d28d9;
            --primary-shadow: rgba(109, 40, 217, 0.4);
            --accent-500: #10b981;
            --accent-600: #059669;
        }
        .theme-blue {
            --primary-500: #3b82f6;
            --primary-600: #2563eb;
            --primary-700: #1d4ed8;
            --primary-shadow: rgba(59, 130, 246, 0.4);
            --accent-500: #0ea5e9;
            --accent-600: #0284c7;
        }
        .theme-green {
            --primary-500: #10b981;
            --primary-600: #059669;
            --primary-700: #047857;
            --primary-shadow: rgba(16, 185, 129, 0.4);
            --accent-500: #14b8a6;
            --accent-600: #0d9488;
        }
        .toast {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
        }
        input[type="radio"]:checked + label {
            border-color: var(--primary-700);
            box-shadow: 0 0 0 2px var(--primary-shadow);
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .star-rating {
            color: #d1d5db; /* gray-300 */
        }
        .star-rating .filled {
            color: #f59e0b; /* amber-500 */
        }
        body.modal-open {
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex flex-col items-center min-h-screen p-4">

    <div class="w-full max-w-md mx-auto">
        <!-- Header & Navigation -->
        <header class="bg-white p-4 rounded-xl shadow-lg mb-6 sticky top-4 z-10">
            <div class="flex justify-between items-center">
                <button id="header-quiz-btn" class="text-xl font-bold text-slate-700 hover:text-[var(--primary-600)] transition-colors">Vocabulary Quiz</button>
                <div class="relative" id="nav-dropdown-container">
                    <button id="nav-toggle-btn" class="p-2 rounded-md hover:bg-slate-100">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                    </button>
                    <div id="nav-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-xl py-1">
                        <a href="#" data-page="main-page" class="nav-link block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">Quiz Hub</a>
                        <a href="#" data-page="list-page" class="nav-link block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">Phrase List</a>
                        <a href="#" data-page="add-page" class="nav-link block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">Add & Import</a>
                        <a href="#" data-page="stats-page" class="nav-link block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">Statistics</a>
                        <a href="#" data-page="history-page" class="nav-link block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">Quiz History</a>
                        <a href="#" data-page="settings-page" class="nav-link block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">Settings</a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Page Container -->
        <main>
            <!-- 1. Main Page / Quiz Hub -->
            <div id="main-page" class="page active">
                <div class="text-center bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">Ready to learn?</h2>
                    <p class="text-slate-500 mt-2 mb-6">Start a new quiz session to practice your vocabulary.</p>
                    <button id="go-to-quiz-setup-btn" class="w-full bg-[var(--accent-500)] text-white font-bold py-3 px-4 rounded-lg hover:bg-[var(--accent-600)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--accent-500)] transition-colors text-lg">
                        Start Quiz
                    </button>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                     <h3 class="text-xl font-semibold mb-4 text-slate-700">Quiz Suggestions</h3>
                     <div id="quiz-suggestions" class="space-y-3">
                        <p class="text-sm text-slate-500">Practice some phrases to get suggestions here!</p>
                     </div>
                </div>
            </div>

            <!-- 2. List of Words Page -->
            <div id="list-page" class="page">
                 <div id="card-list-container" class="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h2 class="text-xl font-semibold mb-4">Your Phrases (<span id="card-count">0</span>)</h2>
                    <div class="mb-4">
                        <label for="lecture-filter" class="sr-only">Filter by lecture</label>
                        <select id="lecture-filter" class="block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-[var(--primary-500)] focus:ring-1 focus:ring-[var(--primary-500)]"></select>
                    </div>
                     <div id="card-list" class="space-y-4 max-h-96 overflow-y-auto">
                        <!-- Word list will be rendered here -->
                     </div>
                </div>
            </div>

            <!-- 3. Adding & Importing Page -->
            <div id="add-page" class="page">
                 <!-- Section to Add New Cards -->
                <div id="add-card-section" class="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h2 class="text-xl font-semibold mb-4">Add a New Phrase</h2>
                    <form id="add-card-form" class="space-y-4">
                        <div>
                            <label for="lecture" class="block text-sm font-medium text-slate-600">Lecture / Group</label>
                            <input type="text" id="lecture" placeholder="e.g., Chapter 1" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--primary-500)] focus:ring-1 focus:ring-[var(--primary-500)]">
                        </div>
                        <div>
                            <label for="english-word" class="block text-sm font-medium text-slate-600">English</label>
                            <input type="text" id="english-word" placeholder="Enter English phrase..." class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--primary-500)] focus:ring-1 focus:ring-[var(--primary-500)]">
                        </div>
                        <div>
                            <label for="german-word" class="block text-sm font-medium text-slate-600">German</label>
                            <input type="text" id="german-word" placeholder="Enter German phrase..." class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--primary-500)] focus:ring-1 focus:ring-[var(--primary-500)]">
                        </div>
                        <div class="flex items-center gap-2">
                            <button type="button" id="translate-btn" class="w-full px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition-colors text-sm whitespace-nowrap flex items-center justify-center min-w-[100px]">
                                <span id="translate-btn-text">Translate</span>
                                <svg id="translate-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            </button>
                            <button type="submit" class="w-full bg-[var(--primary-600)] text-white font-bold py-2 px-4 rounded-lg hover:bg-[var(--primary-700)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--primary-500)] transition-colors">Add Card</button>
                        </div>
                    </form>
                </div>
                 <!-- Import/Export -->
                 <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h2 class="text-xl font-semibold mb-4">Manage All App Data</h2>
                    <div class="flex gap-4">
                        <button id="import-btn" class="w-full flex items-center justify-center gap-2 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-2 px-3 rounded-lg transition-colors">Import Data</button>
                        <input type="file" id="import-file-input" class="hidden" accept=".json">
                        <button id="export-btn" class="w-full flex items-center justify-center gap-2 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-2 px-3 rounded-lg transition-colors">Export Data</button>
                    </div>
                </div>
                <!-- Add from Image -->
                <div id="image-add-section" class="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h2 class="text-xl font-semibold mb-4">Add from Image</h2>
                    <button id="upload-image-btn" class="w-full flex items-center justify-center gap-2 bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700 focus:outline-none transition-colors">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                        Upload Image
                    </button>
                    <input type="file" id="image-upload-input" class="hidden" accept="image/*">
                </div>
                <!-- Add from Text -->
                <div id="text-add-section" class="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h2 class="text-xl font-semibold mb-4">Add from Text / Clipboard</h2>
                    <button id="add-from-text-btn" class="w-full flex items-center justify-center gap-2 bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700 focus:outline-none transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-paste"><path d="M12 2H8a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2h-4"/><path d="M16 4h-4a2 2 0 0 0-2 2v2"/><path d="M12 14h0"/><path d="M15 11h0"/><path d="M9 11h0"/><path d="M12 8h0"/></svg>
                        Paste or Upload Text
                    </button>
                </div>
            </div>

            <!-- 4. Statistics Page -->
            <div id="stats-page" class="page">
                 <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h2 class="text-xl font-semibold mb-4">Performance Statistics</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr>
                                    <th scope="col" class="px-4 py-3">Quiz Mode</th>
                                    <th scope="col" class="px-4 py-3 text-center">Correct</th>
                                    <th scope="col" class="px-4 py-3 text-center">Incorrect</th>
                                    <th scope="col" class="px-4 py-3 text-center">Success %</th>
                                </tr>
                            </thead>
                            <tbody id="stats-table-body">
                                <!-- Stats will be rendered here -->
                            </tbody>
                        </table>
                    </div>
                 </div>
            </div>

            <!-- 5. Quiz History Page -->
            <div id="history-page" class="page">
                <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h2 class="text-xl font-semibold mb-4">Quiz History</h2>
                    <div id="history-list" class="space-y-4 max-h-96 overflow-y-auto">
                        <!-- History items will be rendered here -->
                    </div>
                </div>
            </div>

             <!-- 6. Settings Page -->
            <div id="settings-page" class="page">
                <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h2 class="text-xl font-semibold mb-4">Settings</h2>
                    <form id="settings-form" class="space-y-6">
                        <div>
                            <h3 class="font-medium text-slate-600 mb-2">Theme</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <input type="radio" name="theme" id="theme-blue" value="blue" class="hidden">
                                <label for="theme-blue" class="block text-center p-3 border-2 border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition-all">Light Blue</label>
                                
                                <input type="radio" name="theme" id="theme-green" value="green" class="hidden">
                                <label for="theme-green" class="block text-center p-3 border-2 border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition-all">Green</label>
                            </div>
                        </div>
                         <div>
                            <h3 class="font-medium text-slate-600 mb-2">Quiz Behavior</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="auto-advance-correct-time" class="block text-sm font-medium text-slate-600">Auto-Advance on Correct (sec)</label>
                                    <input type="number" id="auto-advance-correct-time" min="0" max="10" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--primary-500)] focus:ring-1 focus:ring-[var(--primary-500)]">
                                </div>
                                <div>
                                    <label for="auto-advance-wrong-time" class="block text-sm font-medium text-slate-600">Auto-Advance on Wrong (sec)</label>
                                    <input type="number" id="auto-advance-wrong-time" min="1" max="10" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--primary-500)] focus:ring-1 focus:ring-[var(--primary-500)]">
                                </div>
                                 <div>
                                    <label for="max-quiz-questions" class="block text-sm font-medium text-slate-600">Max Questions per Quiz</label>
                                    <input type="number" id="max-quiz-questions" min="5" max="100" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--primary-500)] focus:ring-1 focus:ring-[var(--primary-500)]">
                                </div>
                                 <div>
                                    <label for="repeat-after-input" class="block text-sm font-medium text-slate-600">Repeat After Failure (questions)</label>
                                    <input type="number" id="repeat-after-input" min="1" max="20" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--primary-500)] focus:ring-1 focus:ring-[var(--primary-500)]">
                                </div>
                            </div>
                        </div>
                        <div>
                             <h3 class="font-medium text-slate-600 mb-2">Bin Thresholds</h3>
                             <div class="space-y-3">
                                 <div>
                                     <label for="bin1-threshold" class="flex justify-between text-sm font-medium text-slate-600"><span>Bin 1 (Needs Practice)</span> <span id="bin1-label">0-25%</span></label>
                                     <input type="range" id="bin1-threshold" min="10" max="48" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                                 </div>
                                 <div>
                                     <label for="bin2-threshold" class="flex justify-between text-sm font-medium text-slate-600"><span>Bin 2 (Getting There)</span> <span id="bin2-label">25-50%</span></label>
                                     <input type="range" id="bin2-threshold" min="26" max="73" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                                 </div>
                                 <div>
                                     <label for="bin3-threshold" class="flex justify-between text-sm font-medium text-slate-600"><span>Bin 3 (Good Job)</span> <span id="bin3-label">50-75%</span></label>
                                     <input type="range" id="bin3-threshold" min="51" max="98" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                                 </div>
                             </div>
                        </div>
                        <div>
                             <button type="button" id="save-settings-btn" class="w-full bg-[var(--primary-600)] text-white font-bold py-2 px-4 rounded-lg hover:bg-[var(--primary-700)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--primary-500)] transition-colors">Save Settings</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>

        <footer class="text-center text-xs text-slate-400 mt-6 pb-4">
            <p>Vocabulary Quiz - v1.0.0</p>
        </footer>
        
        <!-- MODALS & OVERLAYS (not part of main pages) -->
        <!-- Image Parser View -->
        <div id="image-parser-view" class="hidden fixed inset-x-4 top-1/2 -translate-y-1/2 max-w-md mx-auto z-20 bg-white rounded-xl shadow-lg flex flex-col max-h-[90vh]">
            <div class="p-6 overflow-y-auto">
                <h2 class="text-xl font-semibold mb-4">Phrases from Image</h2>
                <img id="image-preview" src="#" alt="Image preview" class="max-w-full rounded-lg mb-4 max-h-60 object-contain mx-auto"/>
                <div id="ocr-status" class="text-center text-slate-600 mb-4 p-3 bg-slate-100 rounded-lg"></div>
                
                <div id="image-parse-controls" class="hidden">
                    <div class="mb-4">
                        <label for="image-lecture" class="block text-sm font-medium text-slate-600">Add to Lecture / Group</label>
                        <input type="text" id="image-lecture" placeholder="e.g., Chapter 1" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--primary-500)] focus:ring-1 focus:ring-[var(--primary-500)]">
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-sm text-slate-500">Select phrases to add:</p>
                        <label class="text-sm flex items-center gap-1 cursor-pointer"><input type="checkbox" id="select-all-words-cb"> Select All</label>
                    </div>
                    <div id="word-pair-list" class="flex flex-col gap-2 max-h-48 overflow-y-auto border rounded-lg p-2 bg-slate-50"></div>
                    <button id="add-selected-words-btn" class="mt-4 w-full bg-[var(--primary-600)] text-white font-bold py-2 px-4 rounded-lg hover:bg-[var(--primary-700)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--primary-500)] transition-colors">Add Selected Phrases</button>
                </div>
                <button id="back-from-image-btn" class="mt-6 w-full text-center text-sm text-slate-500 hover:text-slate-700 py-1">Close</button>
            </div>
        </div>

        <!-- Text Parser View -->
        <div id="text-parser-view" class="hidden fixed inset-x-4 top-1/2 -translate-y-1/2 max-w-md mx-auto z-20 bg-white rounded-xl shadow-lg flex flex-col max-h-[90vh]">
            <div class="p-6 overflow-y-auto">
                <h2 class="text-xl font-semibold mb-4">Phrases from Text</h2>
                <p class="text-sm text-slate-500 mb-2">Paste a list of words or phrases (one per line) or upload a .txt file.</p>
                <textarea id="text-input-area" class="w-full h-32 p-2 border rounded-lg bg-slate-50 focus:ring-[var(--primary-500)] focus:border-[var(--primary-500)]" placeholder="A phrase on one line&#10;Another on the next..."></textarea>
                <div class="text-right">
                    <button id="upload-text-file-btn" class="text-sm text-blue-600 hover:underline mt-1">Upload .txt file</button>
                    <input type="file" id="text-file-input" class="hidden" accept="text/plain">
                </div>
                <button id="process-text-btn" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors mt-4">Process List</button>
                <div id="text-parse-status" class="text-center text-slate-600 mt-4 p-3 bg-slate-100 rounded-lg hidden"></div>
                <div id="text-parse-controls" class="hidden mt-4">
                    <div class="mb-4">
                    <label for="text-lecture" class="block text-sm font-medium text-slate-600">Add to Lecture / Group</label>
                    <input type="text" id="text-lecture" placeholder="e.g., Chapter 1" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--primary-500)] focus:ring-1 focus:ring-[var(--primary-500)]">
                </div>
                <div class="flex justify-between items-center mb-2">
                        <p class="text-sm text-slate-500">Select phrases to add:</p>
                        <label class="text-sm flex items-center gap-1 cursor-pointer"><input type="checkbox" id="text-select-all-words-cb"> Select All</label>
                </div>
                    <div id="text-word-pair-list" class="flex flex-col gap-2 max-h-48 overflow-y-auto border rounded-lg p-2 bg-slate-50"></div>
                    <button id="add-selected-text-words-btn" class="mt-4 w-full bg-[var(--primary-600)] text-white font-bold py-2 px-4 rounded-lg hover:bg-[var(--primary-700)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--primary-500)] transition-colors">Add Selected Phrases</button>
                </div>
                <button id="back-from-text-btn" class="mt-6 w-full text-center text-sm text-slate-500 hover:text-slate-700 py-1">Close</button>
            </div>
        </div>

        <!-- Quiz Setup View -->
        <div id="quiz-setup-view" class="hidden fixed inset-x-4 top-1/2 -translate-y-1/2 max-w-md mx-auto z-20 bg-white rounded-xl shadow-lg flex flex-col max-h-[90vh]">
             <div class="p-6 overflow-y-auto">
                <h2 class="text-xl font-semibold mb-4 text-center">Quiz Setup</h2>
                <div class="space-y-5">
                    <div>
                        <h3 class="font-medium text-slate-600 mb-2">1. Choose Lecture</h3>
                        <select id="quiz-lecture-filter" class="block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-[var(--primary-500)] focus:ring-1 focus:ring-[var(--primary-500)]"></select>
                    </div>
                    <div>
                        <h3 class="font-medium text-slate-600 mb-2">2. Choose Direction</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="radio" name="quiz-direction" id="dir-en-de" value="en-de" class="hidden">
                            <label for="dir-en-de" class="block text-center p-3 border-2 border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition-all">English to German</label>
                            <input type="radio" name="quiz-direction" id="dir-de-en" value="de-en" class="hidden" checked>
                            <label for="dir-de-en" class="block text-center p-3 border-2 border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition-all">German to English</label>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-medium text-slate-600 mb-2">3. Choose Mode</h3>
                        <div class="space-y-2">
                            <input type="radio" name="quiz-mode" id="mode-typing" value="typing" class="hidden">
                            <label for="mode-typing" class="block w-full text-left p-3 border-2 border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition-all">📝 Type the answer</label>
                            <input type="radio" name="quiz-mode" id="mode-choice" value="choice" class="hidden" checked>
                            <label for="mode-choice" class="block w-full text-left p-3 border-2 border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition-all">🖱️ Multiple choice</label>
                            <input type="radio" name="quiz-mode" id="mode-speech" value="speech" class="hidden">
                            <label for="mode-speech" class="block w-full text-left p-3 border-2 border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition-all">🗣️ Speak the answer</label>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex flex-col gap-2">
                    <button id="start-quiz-btn" class="w-full bg-[var(--accent-500)] text-white font-bold py-2 px-4 rounded-lg hover:bg-[var(--accent-600)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--accent-500)] transition-colors">Let's Go!</button>
                    <button id="back-to-main-btn" class="w-full text-center text-sm text-slate-500 hover:text-slate-700 py-1">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Quiz Section -->
        <div id="quiz-section" class="hidden fixed inset-x-4 top-1/2 -translate-y-1/2 max-w-md mx-auto z-20 bg-white rounded-xl shadow-lg flex flex-col max-h-[90vh]">
            <div class="p-6 overflow-y-auto">
                <div class="text-center mb-4">
                    <div id="quiz-prompt" class="flex items-center justify-center gap-2">
                        <p id="quiz-word" class="text-3xl font-bold text-slate-700"></p>
                        <button id="speak-question-btn" class="hidden p-2 rounded-full bg-slate-200 hover:bg-slate-300 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                        </button>
                    </div>
                    <p id="quiz-prompt-text" class="text-sm text-slate-500 mt-2"></p>
                </div>
                <div id="quiz-input-area" class="space-y-4">
                    <div id="typing-input-container">
                        <input type="text" id="answer-input" placeholder="Type your answer here..." class="block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--primary-500)] focus:ring-1 focus:ring-[var(--primary-500)]">
                        <button id="check-answer-btn" class="mt-4 w-full bg-[var(--primary-600)] text-white font-bold py-2 px-4 rounded-lg hover:bg-[var(--primary-700)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--primary-500)] transition-colors">Check Answer</button>
                    </div>
                    <div id="choice-input-container" class="hidden space-y-2"></div>
                    <div id="speech-input-container" class="hidden text-center">
                        <button id="listen-btn" class="w-full flex items-center justify-center gap-2 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 focus:outline-none transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line></svg>
                            <span id="listen-btn-text">Start Listening</span>
                        </button>
                        <p id="speech-recognition-status" class="text-sm text-slate-500 mt-2 h-5"></p>
                    </div>
                </div>
                <div id="result-area" class="hidden text-center mt-4 p-4 rounded-lg">
                    <p id="result-text" class="font-semibold text-lg"></p>
                    <div class="flex items-center justify-center gap-2 mt-2">
                        <p id="correct-answer-text" class="text-slate-600"></p>
                        <button id="speak-btn" class="p-2 rounded-full bg-slate-200 hover:bg-slate-300 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                        </button>
                    </div>
                    <button id="next-question-btn" class="mt-4 w-full bg-[var(--accent-500)] text-white font-bold py-2 px-4 rounded-lg hover:bg-[var(--accent-600)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--accent-500)] transition-colors">Next</button>
                </div>
                <p id="quiz-reason" class="text-xs text-center text-slate-500 mt-4 mb-2 h-4"></p>
                <div class="mt-2">
                    <div class="flex justify-between text-sm text-slate-500 mb-1">
                        <span>Progress</span>
                        <span id="progress-text">0 / 0</span>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-2.5">
                        <div id="progress-bar" class="bg-[var(--primary-600)] h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
                <button id="end-quiz-btn" class="mt-4 w-full text-center text-sm text-slate-500 hover:text-slate-700">End Quiz</button>
            </div>
        </div>
        
        <!-- Quiz Feedback View -->
        <div id="quiz-feedback-view" class="hidden fixed inset-x-4 top-1/2 -translate-y-1/2 max-w-md mx-auto z-20 bg-white rounded-xl shadow-lg flex flex-col max-h-[90vh]">
            <div class="p-6 overflow-y-auto text-center">
                <h2 id="feedback-title" class="text-2xl font-bold text-slate-800 mb-2">Quiz Complete!</h2>
                <div id="feedback-stars" class="text-5xl my-4"></div>
                <p id="feedback-message" class="text-slate-600 mb-4"></p>
                <p class="font-semibold text-lg"><span id="feedback-correct">0</span> / <span id="feedback-total">0</span> correct</p>
                <button id="back-to-hub-btn" class="mt-6 w-full bg-[var(--primary-600)] text-white font-bold py-2 px-4 rounded-lg hover:bg-[var(--primary-700)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--primary-500)] transition-colors">Back to Quiz Hub</button>
            </div>
        </div>

        <!-- Overlay for modals -->
        <div id="modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-10"></div>

        <!-- Toast Notification -->
        <div id="toast" class="toast fixed bottom-5 right-5 bg-slate-800 text-white py-2 px-4 rounded-lg shadow-xl z-30">
            <span id="toast-message"></span>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Pre-loaded default lectures data (omitted for brevity) ---
            const defaultLecturesData = [
                { english: "bat", german: "Fledermaus", lecture: "Animals" },
                { english: "bird", german: "Vogel", lecture: "Animals" },
                { english: "chick", german: "Küken", lecture: "Animals" },
                { english: "cow", german: "Kuh", lecture: "Animals" },
                { english: "duck", german: "Ente", lecture: "Animals" },
                { english: "frog", german: "Frosch", lecture: "Animals" },
                { english: "goat", german: "Ziege", lecture: "Animals" },
                { english: "hen", german: "Henne", lecture: "Animals" },
                { english: "horse", german: "Pferd", lecture: "Animals" },
                { english: "pig", german: "Schwein", lecture: "Animals" },
                { english: "sheep", german: "Schaf", lecture: "Animals" },
                { english: "spider", german: "Spinne", lecture: "Animals" },
                { english: "bear", german: "Bär", lecture: "Animals" },
                { english: "monkey", german: "Affe", lecture: "Animals" },
                { english: "tiger", german: "Tiger", lecture: "Animals" },
                { english: "budgie", german: "Wellensittich", lecture: "Animals" },
                { english: "cat", german: "Katze", lecture: "Animals" },
                { english: "dog", german: "Hund", lecture: "Animals" },
                { english: "fish", german: "Fisch", lecture: "Animals" },
                { english: "guinea pig", german: "Meerschweinchen", lecture: "Animals" },
                { english: "hamster", german: "Hamster", lecture: "Animals" },
                { english: "mouse", german: "Maus", lecture: "Animals" },
                { english: "rabbit", german: "Kaninchen", lecture: "Animals" },
                { english: "rat", german: "Ratte", lecture: "Animals" },
                { english: "turtle", german: "Schildkröte", lecture: "Animals" },
                { english: "egg", german: "Ei", lecture: "Food and Drinks" },
                { english: "fish and chips", german: "Fisch und Pommes", lecture: "Food and Drinks" },
                { english: "ham", german: "Schinken", lecture: "Food and Drinks" },
                { english: "hamburger", german: "Hamburger", lecture: "Food and Drinks" },
                { english: "jam", german: "Marmelade", lecture: "Food and Drinks" },
                { english: "juice", german: "Saft", lecture: "Food and Drinks" },
                { english: "milk", german: "Milch", lecture: "Food and Drinks" },
                { english: "muesli", german: "Müsli", lecture: "Food and Drinks" },
                { english: "pizza", german: "Pizza", lecture: "Food and Drinks" },
                { english: "salad", german: "Salat", lecture: "Food and Drinks" },
                { english: "sausages", german: "Würstchen", lecture: "Food and Drinks" },
                { english: "spaghetti", german: "Spaghetti", lecture: "Food and Drinks" },
                { english: "tea", german: "Tee", lecture: "Food and Drinks" },
                { english: "toast", german: "Toast", lecture: "Food and Drinks" },
                { english: "yoghurt", german: "Joghurt", lecture: "Food and Drinks" },
                { english: "apple", german: "Apfel", lecture: "Food and Drinks" },
                { english: "banana", german: "Banane", lecture: "Food and Drinks" },
                { english: "lemon", german: "Zitrone", lecture: "Food and Drinks" },
                { english: "orange", german: "Orange", lecture: "Food and Drinks" },
                { english: "strawberry", german: "Erdbeere", lecture: "Food and Drinks" },
                { english: "tomato", german: "Tomate", lecture: "Food and Drinks" },
                { english: "bread", german: "Brot", lecture: "Food and Drinks" },
                { english: "butter", german: "Butter", lecture: "Food and Drinks" },
                { english: "cheese", german: "Käse", lecture: "Food and Drinks" },
                { english: "cornflakes", german: "Cornflakes", lecture: "Food and Drinks" },
                { english: "bathroom", german: "Badezimmer", lecture: "Rooms and Furniture" },
                { english: "bedroom", german: "Schlafzimmer", lecture: "Rooms and Furniture" },
                { english: "children's room", german: "Kinderzimmer", lecture: "Rooms and Furniture" },
                { english: "hall", german: "Flur", lecture: "Rooms and Furniture" },
                { english: "kitchen", german: "Küche", lecture: "Rooms and Furniture" },
                { english: "living room", german: "Wohnzimmer", lecture: "Rooms and Furniture" },
                { english: "upstairs", german: "oben", lecture: "Rooms and Furniture" },
                { english: "downstairs", german: "unten", lecture: "Rooms and Furniture" },
                { english: "armchair", german: "Sessel", lecture: "Rooms and Furniture" },
                { english: "bed", german: "Bett", lecture: "Rooms and Furniture" },
                { english: "chair", german: "Stuhl", lecture: "Rooms and Furniture" },
                { english: "cupboard", german: "Schrank", lecture: "Rooms and Furniture" },
                { english: "fridge", german: "Kühlschrank", lecture: "Rooms and Furniture" },
                { english: "lamp", german: "Lampe", lecture: "Rooms and Furniture" },
                { english: "oven", german: "Ofen", lecture: "Rooms and Furniture" },
                { english: "picture", german: "Bild", lecture: "Rooms and Furniture" },
                { english: "shelf", german: "Regal", lecture: "Rooms and Furniture" },
                { english: "sofa", german: "Sofa", lecture: "Rooms and Furniture" },
                { english: "table", german: "Tisch", lecture: "Rooms and Furniture" },
                { english: "TV", german: "Fernseher", lecture: "Rooms and Furniture" },
                { english: "wardrobe", german: "Kleiderschrank", lecture: "Rooms and Furniture" },
                { english: "bathtub", german: "Badewanne", lecture: "Rooms and Furniture" },
                { english: "shower", german: "Dusche", lecture: "Rooms and Furniture" },
                { english: "toilet", german: "Toilette", lecture: "Rooms and Furniture" },
                { english: "washbasin", german: "Waschbecken", lecture: "Rooms and Furniture" },
                { english: "ghost", german: "Geist", lecture: "Halloween" },
                { english: "monster", german: "Monster", lecture: "Halloween" },
                { english: "moon", german: "Mond", lecture: "Halloween" },
                { english: "pumpkin", german: "Kürbis", lecture: "Halloween" },
                { english: "spider's web", german: "Spinnennetz", lecture: "Halloween" },
                { english: "sweets", german: "Süßigkeiten", lecture: "Halloween" },
                { english: "vampire", german: "Vampir", lecture: "Halloween" },
                { english: "broom", german: "Besen", lecture: "Halloween" },
                { english: "hat", german: "Hut", lecture: "Halloween" },
                { english: "witch", german: "Hexe", lecture: "Halloween" },
                { english: "football", german: "Fußball", lecture: "Toys" },
                { english: "jigsaw puzzle", german: "Puzzle", lecture: "Toys" },
                { english: "ball", german: "Ball", lecture: "Toys" },
                { english: "story book", german: "Märchenbuch", lecture: "Toys" },
                { english: "teddy bear", german: "Teddybär", lecture: "Toys" },
                { english: "cards", german: "Karten", lecture: "Toys" },
                { english: "toy car", german: "Spielzeugauto", lecture: "Toys" },
                { english: "toy plane", german: "Spielzeugflugzeug", lecture: "Toys" },
                { english: "toy train", german: "Spielzeugeisenbahn", lecture: "Toys" },
                { english: "computer game", german: "Computerspiel", lecture: "Toys" },
                { english: "in-line skates", german: "Inlineskates", lecture: "Toys" },
                { english: "mountain bike", german: "Mountainbike", lecture: "Toys" },
                { english: "music player", german: "Musikplayer", lecture: "Toys" },
                { english: "skateboard", german: "Skateboard", lecture: "Toys" },
                { english: "skipping rope", german: "Springseil", lecture: "Toys" },
                { english: "playing a computer game", german: "ein Computerspiel spielen", lecture: "Hobbies" },
                { english: "dancing", german: "tanzen", lecture: "Hobbies" },
                { english: "playing football", german: "Fußball spielen", lecture: "Hobbies" },
                { english: "in-line skating", german: "Inlineskaten", lecture: "Hobbies" },
                { english: "listening to music", german: "Musik hören", lecture: "Hobbies" },
                { english: "reading", german: "lesen", lecture: "Hobbies" },
                { english: "riding a bike", german: "Fahrrad fahren", lecture: "Hobbies" },
                { english: "running", german: "laufen", lecture: "Hobbies" },
                { english: "singing", german: "singen", lecture: "Hobbies" },
                { english: "skateboarding", german: "Skateboard fahren", lecture: "Hobbies" },
                { english: "skiing", german: "Skifahren", lecture: "Hobbies" },
                { english: "skipping", german: "Seil springen", lecture: "Hobbies" },
                { english: "swimming", german: "schwimmen", lecture: "Hobbies" },
                { english: "playing table tennis", german: "Tischtennis spielen", lecture: "Hobbies" },
                { english: "walking", german: "spazieren gehen", lecture: "Hobbies" },
                { english: "one", german: "eins", lecture: "Numbers" },
                { english: "two", german: "zwei", lecture: "Numbers" },
                { english: "three", german: "drei", lecture: "Numbers" },
                { english: "four", german: "vier", lecture: "Numbers" },
                { english: "five", german: "fünf", lecture: "Numbers" },
                { english: "six", german: "sechs", lecture: "Numbers" },
                { english: "seven", german: "sieben", lecture: "Numbers" },
                { english: "eight", german: "acht", lecture: "Numbers" },
                { english: "nine", german: "neun", lecture: "Numbers" },
                { english: "ten", german: "zehn", lecture: "Numbers" },
                { english: "eleven", german: "elf", lecture: "Numbers" },
                { english: "twelve", german: "zwölf", lecture: "Numbers" },
                { english: "thirteen", german: "dreizehn", lecture: "Numbers" },
                { english: "fourteen", german: "vierzehn", lecture: "Numbers" },
                { english: "fifteen", german: "fünfzehn", lecture: "Numbers" },
                { english: "seventeen", german: "siebzehn", lecture: "Numbers" },
                { english: "eighteen", german: "achtzehn", lecture: "Numbers" },
                { english: "nineteen", german: "neunzehn", lecture: "Numbers" },
                { english: "twenty", german: "zwanzig", lecture: "Numbers" },
                { english: "thirty", german: "dreißig", lecture: "Numbers" },
                { english: "forty", german: "vierzig", lecture: "Numbers" },
                { english: "fifty", german: "fünfzig", lecture: "Numbers" },
                { english: "sixty", german: "sechzig", lecture: "Numbers" },
                { english: "seventy", german: "siebzig", lecture: "Numbers" },
                { english: "eighty", german: "achtzig", lecture: "Numbers" },
                { english: "ninety", german: "neunzig", lecture: "Numbers" },
                { english: "hundred", german: "hundert", lecture: "Numbers" },
                { english: "thousand", german: "tausend", lecture: "Numbers" },
                { english: "red", german: "rot", lecture: "Colours" },
                { english: "blue", german: "blau", lecture: "Colours" },
                { english: "yellow", german: "gelb", lecture: "Colours" },
                { english: "green", german: "grün", lecture: "Colours" },
                { english: "pink", german: "rosa", lecture: "Colours" },
                { english: "orange", german: "orange", lecture: "Colours" },
                { english: "brown", german: "braun", lecture: "Colours" },
                { english: "purple", german: "lila", lecture: "Colours" },
                { english: "black", german: "schwarz", lecture: "Colours" },
                { english: "white", german: "weiß", lecture: "Colours" },
                { english: "father", german: "Vater", lecture: "Family" },
                { english: "mother", german: "Mutter", lecture: "Family" },
                { english: "sister", german: "Schwester", lecture: "Family" },
                { english: "brother", german: "Bruder", lecture: "Family" },
                { english: "grandfather", german: "Großvater", lecture: "Family" },
                { english: "grandmother", german: "Großmutter", lecture: "Family" },
            ];

            // --- DOM Elements ---
            const navToggleBtn = document.getElementById('nav-toggle-btn');
            const navMenu = document.getElementById('nav-menu');
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page');
            const modalOverlay = document.getElementById('modal-overlay');
            const imageParserView = document.getElementById('image-parser-view');
            const textParserView = document.getElementById('text-parser-view');
            const quizSetupView = document.getElementById('quiz-setup-view');
            const quizSection = document.getElementById('quiz-section');
            const quizFeedbackView = document.getElementById('quiz-feedback-view');
            const headerQuizBtn = document.getElementById('header-quiz-btn');
            const goToQuizSetupBtn = document.getElementById('go-to-quiz-setup-btn');
            const quizSuggestionsContainer = document.getElementById('quiz-suggestions');
            const addCardForm = document.getElementById('add-card-form');
            const lectureInput = document.getElementById('lecture');
            const englishWordInput = document.getElementById('english-word');
            const germanWordInput = document.getElementById('german-word');
            const translateBtn = document.getElementById('translate-btn');
            const translateBtnText = document.getElementById('translate-btn-text');
            const translateSpinner = document.getElementById('translate-spinner');
            const importBtn = document.getElementById('import-btn');
            const importFileInput = document.getElementById('import-file-input');
            const exportBtn = document.getElementById('export-btn');
            const cardListEl = document.getElementById('card-list');
            const cardCountEl = document.getElementById('card-count');
            const lectureFilter = document.getElementById('lecture-filter');
            const statsTableBody = document.getElementById('stats-table-body');
            const historyListEl = document.getElementById('history-list');
            const uploadImageBtn = document.getElementById('upload-image-btn');
            const imageUploadInput = document.getElementById('image-upload-input');
            const imagePreview = document.getElementById('image-preview');
            const ocrStatus = document.getElementById('ocr-status');
            const imageParseControls = document.getElementById('image-parse-controls');
            const imageLectureInput = document.getElementById('image-lecture');
            const wordPairList = document.getElementById('word-pair-list');
            const selectAllWordsCb = document.getElementById('select-all-words-cb');
            const addSelectedWordsBtn = document.getElementById('add-selected-words-btn');
            const backFromImageBtn = document.getElementById('back-from-image-btn');
            const addFromTextBtn = document.getElementById('add-from-text-btn');
            const textInputArea = document.getElementById('text-input-area');
            const uploadTextFileBtn = document.getElementById('upload-text-file-btn');
            const textFileInput = document.getElementById('text-file-input');
            const processTextBtn = document.getElementById('process-text-btn');
            const textParseStatus = document.getElementById('text-parse-status');
            const textParseControls = document.getElementById('text-parse-controls');
            const textLectureInput = document.getElementById('text-lecture');
            const textSelectAllWordsCb = document.getElementById('text-select-all-words-cb');
            const textWordPairList = document.getElementById('text-word-pair-list');
            const addSelectedTextWordsBtn = document.getElementById('add-selected-text-words-btn');
            const backFromTextBtn = document.getElementById('back-from-text-btn');
            const quizLectureFilter = document.getElementById('quiz-lecture-filter');
            const startQuizBtn = document.getElementById('start-quiz-btn');
            const backToMainBtn = document.getElementById('back-to-main-btn');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const quizReason = document.getElementById('quiz-reason');
            const quizWord = document.getElementById('quiz-word');
            const speakQuestionBtn = document.getElementById('speak-question-btn');
            const quizPromptText = document.getElementById('quiz-prompt-text');
            const quizInputArea = document.getElementById('quiz-input-area');
            const typingInputContainer = document.getElementById('typing-input-container');
            const choiceInputContainer = document.getElementById('choice-input-container');
            const speechInputContainer = document.getElementById('speech-input-container');
            const answerInput = document.getElementById('answer-input');
            const checkAnswerBtn = document.getElementById('check-answer-btn');
            const listenBtn = document.getElementById('listen-btn');
            const listenBtnText = document.getElementById('listen-btn-text');
            const speechStatus = document.getElementById('speech-recognition-status');
            const resultArea = document.getElementById('result-area');
            const resultText = document.getElementById('result-text');
            const correctAnswerText = document.getElementById('correct-answer-text');
            const speakBtn = document.getElementById('speak-btn');
            const nextQuestionBtn = document.getElementById('next-question-btn');
            const endQuizBtn = document.getElementById('end-quiz-btn');
            const feedbackTitle = document.getElementById('feedback-title');
            const feedbackStars = document.getElementById('feedback-stars');
            const feedbackMessage = document.getElementById('feedback-message');
            const feedbackCorrect = document.getElementById('feedback-correct');
            const feedbackTotal = document.getElementById('feedback-total');
            const backToHubBtn = document.getElementById('back-to-hub-btn');
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            const bin1Slider = document.getElementById('bin1-threshold');
            const bin2Slider = document.getElementById('bin2-threshold');
            const bin3Slider = document.getElementById('bin3-threshold');
            const bin1Label = document.getElementById('bin1-label');
            const bin2Label = document.getElementById('bin2-label');
            const bin3Label = document.getElementById('bin3-label');
            
            // --- App State ---
            let flashcards = [];
            let quizHistory = [];
            let quizQueue = [];
            let currentCard = null;
            let quizSettings = { lecture: 'all', direction: 'de-en', mode: 'choice' };
            let quizSessionStats = { correct: 0, presented: 0, initialQueueLength: 0 };
            let autoAdvanceTimer = null;
            let settings;
            
            // --- App Initialization & Navigation ---
            function showPage(pageId) {
                pages.forEach(p => p.classList.toggle('active', p.id === pageId));
                navMenu.classList.add('hidden');
                
                if (pageId === 'list-page') updateCardList();
                if (pageId === 'stats-page') updateStatsTable();
                if (pageId === 'history-page') updateHistoryPage();
                if (pageId === 'main-page') updateQuizSuggestions();
                if (pageId === 'settings-page') updateSettingsPage();
            }

            navToggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                navMenu.classList.toggle('hidden');
            });
            
            document.addEventListener('click', () => navMenu.classList.add('hidden'));
            
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage(e.target.dataset.page);
                });
            });

            function openQuizSetup() {
                 updateQuizLectureFilter();
                // Set defaults from last quiz if available
                if (quizHistory.length > 0) {
                    quizLectureFilter.value = quizHistory[0].lecture;
                    document.querySelector(`input[name="quiz-direction"][value="${quizHistory[0].direction}"]`).checked = true;
                    document.querySelector(`input[name="quiz-mode"][value="${quizHistory[0].mode}"]`).checked = true;
                } else { // Fallback to app defaults if no history
                     document.querySelector(`input[name="quiz-direction"][value="de-en"]`).checked = true;
                     document.querySelector(`input[name="quiz-mode"][value="choice"]`).checked = true;
                }
                showModal(quizSetupView);
            }

            function showModal(modalElement) {
                modalOverlay.classList.remove('hidden');
                modalElement.classList.remove('hidden');
                document.body.classList.add('modal-open');
            }
            function hideModal(modalElement) {
                modalOverlay.classList.add('hidden');
                modalElement.classList.add('hidden');
                document.body.classList.remove('modal-open');
            }
            
            headerQuizBtn.addEventListener('click', openQuizSetup);
            goToQuizSetupBtn.addEventListener('click', openQuizSetup);
            uploadImageBtn.addEventListener('click', () => imageUploadInput.click());
            addFromTextBtn.addEventListener('click', () => showModal(textParserView));
            
            backFromImageBtn.addEventListener('click', () => hideModal(imageParserView));
            backFromTextBtn.addEventListener('click', () => hideModal(textParserView));
            backToMainBtn.addEventListener('click', () => hideModal(quizSetupView));
            backToHubBtn.addEventListener('click', () => {
                hideModal(quizFeedbackView);
                showPage('main-page');
            });

            // --- Speech Synthesis & Recognition ---
            const synth = window.speechSynthesis;
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;
            
            if (!SpeechRecognition) {
                document.getElementById('mode-speech').disabled = true;
                document.querySelector('label[for="mode-speech"]').classList.add('opacity-50', 'cursor-not-allowed');
                document.querySelector('label[for="mode-speech"]').title = "Speech recognition not supported in this browser.";
            } else {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
            }

            function speak(text, lang = 'en-US', onEndCallback) {
                if (!synth || !text) {
                    if (onEndCallback) onEndCallback();
                    return;
                }
                if (synth.speaking) {
                    synth.cancel();
                }
                
                const utterThis = new SpeechSynthesisUtterance(text);
                utterThis.lang = lang;
                
                utterThis.onend = () => {
                    if (onEndCallback) {
                        onEndCallback();
                    }
                };
                
                utterThis.onerror = (event) => {
                    console.error('Speech synthesis error:', event);
                    if (onEndCallback) {
                        onEndCallback(); // Ensure quiz continues even if audio fails
                    }
                };

                // A small delay helps prevent issues in some browsers where onend might not fire if speech is cancelled and restarted too quickly.
                setTimeout(() => synth.speak(utterThis), 50);
            }
            
            // --- Toast Notifications ---
            function showToast(message, isError = false) {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toast-message');
                toastMessage.textContent = message;
                toast.classList.toggle('bg-red-600', isError);
                toast.classList.toggle('bg-slate-800', !isError);
                toast.classList.add('show');
                setTimeout(() => { toast.classList.remove('show'); }, 3000);
            }
            
            // --- Translation API Calls (omitted for brevity) ---
            async function callGeminiAPI(userQuery, expectJson = false) {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: userQuery }] }] };
                if (expectJson) {
                    payload.generationConfig = {
                        responseMimeType: "application/json",
                        responseSchema: { type: "OBJECT", properties: { "corrected_source": { "type": "STRING" }, "translation": { "type": "STRING" } }, required: ["corrected_source", "translation"] }
                    };
                }
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) return expectJson ? JSON.parse(text) : text.trim();
                    throw new Error("Invalid API response.");
                } catch (error) { console.error('API call failed:', error); throw error; }
            }
            async function callSimpleTranslateAPI(text, targetLang) {
                const sourceLang = targetLang === 'German' ? 'English' : 'German';
                const query = `Translate the following ${sourceLang} text to ${targetLang}, ensuring correct capitalization (e.g. for German nouns). Provide ONLY the translation. Text: "${text}"`;
                return callGeminiAPI(query);
            }
            async function callTranslateAndCorrectAPI(phrase, sourceLang) {
                const targetLang = sourceLang === 'english' ? 'German' : 'English';
                const query = `Correct typos in the ${sourceLang} phrase, then translate to ${targetLang}. Rules: Capitalize German nouns. In English, do NOT capitalize common nouns unless at sentence start. Capitalize proper nouns. Result as JSON with "corrected_source" and "translation". Phrase: "${phrase}"`;
                return callGeminiAPI(query, true);
            }
            async function callLanguageDetectionAPI(phrase) {
                const query = `Is this "English" or "German"? Phrase: "${phrase}"`;
                try {
                    const result = await callGeminiAPI(query);
                    const lang = result.toLowerCase();
                    if (lang.includes('english')) return 'english';
                    if (lang.includes('german')) return 'german';
                    return 'unknown';
                } catch (error) { return 'unknown'; }
            }

            // --- Manual Add & Translate ---
            translateBtn.addEventListener('click', async () => {
                const englishText = englishWordInput.value.trim();
                const germanText = germanWordInput.value.trim();
                let textToTranslate = '', targetLang = '', targetInput = null;

                if (englishText && !germanText) { textToTranslate = englishText; targetLang = 'German'; targetInput = germanWordInput; }
                else if (germanText && !englishText) { textToTranslate = germanText; targetLang = 'English'; targetInput = englishWordInput; }
                else { showToast(englishText && germanText ? "Clear one field to translate." : "Enter a phrase to translate.", true); return; }

                translateBtn.disabled = true;
                translateBtnText.classList.add('hidden');
                translateSpinner.classList.remove('hidden');
                try {
                    const translation = await callSimpleTranslateAPI(textToTranslate, targetLang);
                    if (targetInput) targetInput.value = translation;
                } catch (error) { showToast("Translation failed.", true); }
                finally {
                    translateBtn.disabled = false;
                    translateBtnText.classList.remove('hidden');
                    translateSpinner.classList.add('hidden');
                }
            });

            // --- Image Parsing (OCR) (omitted for brevity) ---
            imageUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    imagePreview.src = event.target.result;
                    showModal(imageParserView);
                    imageParseControls.classList.add('hidden');
                    wordPairList.innerHTML = '';
                    parseImage(file);
                };
                reader.readAsDataURL(file);
                e.target.value = '';
            });
            async function parseImage(file) {
                ocrStatus.innerHTML = 'Initializing...';
                const worker = await Tesseract.createWorker('eng', 1, { logger: m => {
                    ocrStatus.innerHTML = m.status === 'recognizing text' ? `Recognizing... ${Math.round(m.progress * 100)}%` : m.status;
                }});
                try {
                    const { data } = await worker.recognize(file);
                    await worker.terminate();
                    const phrases = [...new Set(data.lines.map(line => line.text.trim()).filter(line => line.length > 3))];
                    if (phrases.length === 0) { ocrStatus.innerHTML = 'No text found.'; return; }
                    ocrStatus.innerHTML = `Found ${phrases.length} phrases. Translating...`;
                    const promises = phrases.map(p => callTranslateAndCorrectAPI(p, 'english').catch(e => ({ error: true, p })));
                    const results = await Promise.all(promises);
                    const wordPairs = results.map(res => res.error ? { english: res.p, german: 'Failed' } : { english: res.corrected_source, german: res.translation });
                    displayBulkWordPairs(wordPairList, wordPairs, 'img');
                    imageParseControls.classList.remove('hidden');
                    ocrStatus.innerHTML = `Processed ${wordPairs.length} phrases.`;
                } catch (error) { ocrStatus.innerHTML = 'Could not recognize text.'; }
            }
            
            // --- Text Parsing (omitted for brevity) ---
            uploadTextFileBtn.addEventListener('click', () => textFileInput.click());
            textFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => { textInputArea.value = event.target.result; };
                reader.readAsText(file);
                e.target.value = '';
            });
            processTextBtn.addEventListener('click', async () => {
                const text = textInputArea.value.trim();
                if (!text) { showToast("Please paste or upload text.", true); return; }
                const phrases = [...new Set(text.split('\n').map(p => p.trim()).filter(p => p.length > 0))];
                
                processTextBtn.disabled = true;
                textParseStatus.classList.remove('hidden');
                textParseControls.classList.add('hidden');
                textParseStatus.textContent = `Found ${phrases.length} phrases. Processing...`;

                const processPhrase = async (phrase) => {
                    try {
                        const lang = await callLanguageDetectionAPI(phrase);
                        if (lang === 'english' || lang === 'german') {
                            const result = await callTranslateAndCorrectAPI(phrase, lang);
                            return lang === 'english'
                                ? { english: result.corrected_source, german: result.translation }
                                : { german: result.corrected_source, english: result.translation };
                        }
                        return { english: phrase, german: 'Language not detected' };
                    } catch (error) { return { english: phrase, german: 'Processing failed' }; }
                };

                try {
                    const promises = phrases.map(processPhrase);
                    const wordPairs = await Promise.all(promises);
                    displayBulkWordPairs(textWordPairList, wordPairs, 'txt');
                    textParseControls.classList.remove('hidden');
                    textParseStatus.textContent = `Processed ${wordPairs.length} phrases.`;
                } catch (error) {
                     showToast("An error occurred during processing.", true);
                     textParseStatus.textContent = 'Processing failed.';
                } finally {
                    processTextBtn.disabled = false;
                }
            });

            // --- Bulk Add Logic (Shared by Image & Text) ---
            function displayBulkWordPairs(listElement, pairs, prefix) {
                listElement.innerHTML = '';
                pairs.forEach((pair, index) => {
                    const el = document.createElement('div');
                    el.className = 'flex items-center gap-2 p-1.5 bg-white rounded';
                    const isFailed = pair.german.toLowerCase().includes('fail') || pair.english.toLowerCase().includes('fail');
                    el.innerHTML = `
                        <input type="checkbox" id="${prefix}-word-pair-${index}" class="${prefix}-word-pair-cb h-4 w-4 rounded border-gray-300 text-[var(--primary-600)] focus:ring-[var(--primary-500)]" data-english="${pair.english}" data-german="${pair.german}" ${isFailed ? 'disabled' : ''}>
                        <label for="${prefix}-word-pair-${index}" class="text-sm flex-grow cursor-pointer ${isFailed ? 'opacity-50' : ''}">${pair.english} &rarr; ${pair.german}</label>`;
                    listElement.appendChild(el);
                });
            }
            selectAllWordsCb.addEventListener('change', (e) => wordPairList.querySelectorAll('.img-word-pair-cb:not(:disabled)').forEach(cb => cb.checked = e.target.checked));
            textSelectAllWordsCb.addEventListener('change', (e) => textWordPairList.querySelectorAll('.txt-word-pair-cb:not(:disabled)').forEach(cb => cb.checked = e.target.checked));

            addSelectedWordsBtn.addEventListener('click', () => addBulkPhrases(wordPairList, imageLectureInput, imageParserView, '.img-word-pair-cb'));
            addSelectedTextWordsBtn.addEventListener('click', () => addBulkPhrases(textWordPairList, textLectureInput, textParserView, '.txt-word-pair-cb'));

            function addBulkPhrases(listElement, lectureElement, modalElement, checkboxClass) {
                const selected = listElement.querySelectorAll(`${checkboxClass}:checked`);
                const lecture = lectureElement.value.trim() || 'General';
                let count = 0;
                let skipped = 0;
                selected.forEach(cb => {
                    const english = cb.dataset.english;
                    const german = cb.dataset.german;
                     const isDuplicate = flashcards.some(card =>
                        card.lecture.toLowerCase() === lecture.toLowerCase() &&
                        card.english.toLowerCase() === english.toLowerCase() &&
                        card.german.toLowerCase() === german.toLowerCase()
                    );
                    if (!isDuplicate) {
                        flashcards.push({ id: Date.now() + count, english, german, lecture, scores: defaultScores() });
                        count++;
                    } else {
                        skipped++;
                    }
                });
                if (count > 0) {
                    saveFlashcards();
                    updateCardList();
                    showToast(`${count} phrases added!`);
                    if(skipped > 0) showToast(`${skipped} duplicates were skipped.`);
                    hideModal(modalElement);
                } else { showToast('No new phrases selected.', true); }
            }

            // --- Card Management & Persistence ---
            const defaultScores = () => ({
                'en-de': { typing: { correct: 0, incorrect: 0, lastTrained: null }, choice: { correct: 0, incorrect: 0, lastTrained: null }, speech: { correct: 0, incorrect: 0, lastTrained: null }},
                'de-en': { typing: { correct: 0, incorrect: 0, lastTrained: null }, choice: { correct: 0, incorrect: 0, lastTrained: null }, speech: { correct: 0, incorrect: 0, lastTrained: null }}
            });
            function saveFlashcards() { localStorage.setItem('flashcards', JSON.stringify(flashcards)); }
            function saveQuizHistory() { localStorage.setItem('quizHistory', JSON.stringify(quizHistory)); }
            
            function loadData() {
                const savedCards = localStorage.getItem('flashcards');
                flashcards = savedCards ? JSON.parse(savedCards) : [];
                
                const savedHistory = localStorage.getItem('quizHistory');
                quizHistory = savedHistory ? JSON.parse(savedHistory) : [];

                const isDefaultDataLoaded = localStorage.getItem('isDefaultDataLoaded_v2');
                if (!isDefaultDataLoaded) {
                    addDefaultLectures();
                    localStorage.setItem('isDefaultDataLoaded_v2', 'true');
                } else {
                     updateCardList();
                }
            }
            
            function addDefaultLectures() {
                let idCounter = flashcards.length > 0 ? Math.max(...flashcards.map(c => c.id)) + 1 : Date.now();
                const newCards = defaultLecturesData.map(item => {
                    if (flashcards.some(c => c.english === item.english && c.lecture === item.lecture)) {
                        return null;
                    }
                    return { id: idCounter++, ...item, scores: defaultScores() };
                }).filter(Boolean);

                if (newCards.length > 0) {
                    flashcards.push(...newCards);
                    saveFlashcards();
                }
                updateCardList();
                showToast('Welcome! Added some starter lectures for you.');
            }

            addCardForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const english = englishWordInput.value.trim();
                const german = germanWordInput.value.trim();
                const lecture = lectureInput.value.trim() || 'General';

                if (!english || !german) {
                    showToast("Both fields are required.", true);
                    return;
                }

                const isDuplicate = flashcards.some(card =>
                    card.lecture.toLowerCase() === lecture.toLowerCase() &&
                    card.english.toLowerCase() === english.toLowerCase() &&
                    card.german.toLowerCase() === german.toLowerCase()
                );

                if (isDuplicate) {
                    showToast("This phrase already exists in this lecture.", true);
                    return;
                }

                flashcards.push({ id: Date.now(), english, german, lecture, scores: defaultScores() });
                saveFlashcards();
                updateCardList();
                showToast(`"${english}" added!`);
                addCardForm.reset();
                lectureInput.value = lecture;
            });

            function getBinForCard(card) {
                const { correct, incorrect } = Object.values(card.scores)
                    .flatMap(dir => Object.values(dir))
                    .reduce((acc, mode) => {
                        acc.correct += mode.correct;
                        acc.incorrect += mode.incorrect;
                        return acc;
                    }, { correct: 0, incorrect: 0 });

                const total = correct + incorrect;
                if (total === 0) return { label: 'NA', color: 'bg-slate-400' };

                const rate = correct / total;
                if (rate < settings.binThresholds.p1 / 100) return { label: `0-${settings.binThresholds.p1}%`, color: 'bg-red-500' };
                if (rate < settings.binThresholds.p2 / 100) return { label: `${settings.binThresholds.p1}-${settings.binThresholds.p2}%`, color: 'bg-orange-500' };
                if (rate < settings.binThresholds.p3 / 100) return { label: `${settings.binThresholds.p2}-${settings.binThresholds.p3}%`, color: 'bg-yellow-500' };
                return { label: `${settings.binThresholds.p3}-100%`, color: 'bg-green-500' };
            }

            function updateCardList() {
                cardCountEl.textContent = flashcards.length;
                const lectures = flashcards.reduce((acc, card) => { (acc[card.lecture] = acc[card.lecture] || []).push(card); return acc; }, {});
                
                const currentFilterValue = lectureFilter.value;
                lectureFilter.innerHTML = '<option value="all">All Phrases</option>';
                Object.keys(lectures).sort().forEach(lecture => lectureFilter.appendChild(new Option(lecture, lecture)));
                lectureFilter.value = currentFilterValue;
                
                cardListEl.innerHTML = '';
                if (flashcards.length > 0) {
                    Object.keys(lectures).sort().forEach(lecture => {
                        const lectureGroup = document.createElement('div');
                        lectureGroup.innerHTML = `<h3 class="font-semibold text-slate-600 border-b pb-1 mb-2">${lecture}</h3>`;
                        
                        lectures[lecture].sort((a,b) => {
                           const { correct: ac, incorrect: ai } = Object.values(a.scores).flatMap(Object.values).reduce((acc, s) => ({ correct: acc.correct + s.correct, incorrect: acc.incorrect + s.incorrect }), { correct: 0, incorrect: 0 });
                           const { correct: bc, incorrect: bi } = Object.values(b.scores).flatMap(Object.values).reduce((acc, s) => ({ correct: acc.correct + s.correct, incorrect: acc.incorrect + s.incorrect }), { correct: 0, incorrect: 0 });
                           const rateA = (ac + ai) === 0 ? -1 : ac / (ac + ai);
                           const rateB = (bc + bi) === 0 ? -1 : bc / (bc + bi);
                           return rateA - rateB;
                        });

                        lectures[lecture].forEach(card => {
                            const cardEl = document.createElement('div');
                            cardEl.className = 'flex justify-between items-start bg-slate-50 p-2 rounded-lg';
                            const bin = getBinForCard(card);
                            cardEl.innerHTML = `
                                <div class="flex-grow">
                                    <div class="flex items-center gap-1">
                                        <p class="text-sm font-medium text-slate-800"><b>${card.english}</b></p>
                                        <button data-speak-english="${card.english}" class="speak-list-btn p-1 rounded-full hover:bg-slate-200"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-slate-500"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg></button>
                                    </div>
                                    <p class="text-sm text-slate-500">/ ${card.german}</p>
                                </div>
                                <div class="flex flex-col items-end">
                                    <span class="text-xs font-bold text-white ${bin.color} px-2 py-0.5 rounded-full mb-2">${bin.label}</span>
                                    <button data-id="${card.id}" class="delete-btn text-red-400 hover:text-red-600 p-1 text-xl leading-none flex items-center justify-center">&times;</button>
                                </div>`;
                            lectureGroup.appendChild(cardEl);
                        });
                        cardListEl.appendChild(lectureGroup);
                    });
                } else { cardListEl.innerHTML = '<p class="text-slate-500 text-sm">Add phrases to get started!</p>'; }
            }
            cardListEl.addEventListener('click', (e) => {
                const speakBtn = e.target.closest('.speak-list-btn');
                const deleteBtn = e.target.closest('.delete-btn');
                if (speakBtn) { speak(speakBtn.dataset.speakEnglish, 'en-US'); }
                if (deleteBtn) {
                    flashcards = flashcards.filter(card => card.id !== Number(deleteBtn.dataset.id));
                    saveFlashcards();
                    updateCardList();
                }
            });

            // --- Import / Export ---
            importBtn.addEventListener('click', () => importFileInput.click());
            exportBtn.addEventListener('click', () => {
                if (flashcards.length === 0 && quizHistory.length === 0) {
                    showToast("No data to export.", true);
                    return;
                }
                const dataToExport = {
                    flashcards: flashcards,
                    quizHistory: quizHistory,
                    settings: settings
                };
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dataToExport, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "vocabulary_data.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            });
            importFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (importedData.flashcards && importedData.quizHistory && importedData.settings) {
                            flashcards = importedData.flashcards;
                            quizHistory = importedData.quizHistory;
                            settings = importedData.settings;
                            saveFlashcards();
                            saveQuizHistory();
                            saveSettings();
                            applySettings();
                            updateCardList();
                            updateHistoryPage();
                            showToast("All data imported successfully!", false);
                            location.reload(); // Easiest way to ensure all states are refreshed
                        } else {
                            throw new Error("Invalid data file structure.");
                        }
                    } catch (error) {
                        console.error(error);
                        showToast("Failed to import data file.", true);
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
            });

            // --- Statistics & Suggestions Logic ---
            function updateStatsTable() {
                const stats = {};
                flashcards.forEach(card => {
                    Object.entries(card.scores).forEach(([dir, modes]) => {
                        Object.entries(modes).forEach(([mode, data]) => {
                            const key = `${dir}-${mode}`;
                            if (!stats[key]) stats[key] = { name: `${dir === 'en-de' ? 'EN→DE' : 'DE→EN'} ${mode}`, c: 0, i: 0 };
                            stats[key].c += data.correct;
                            stats[key].i += data.incorrect;
                        });
                    });
                });
                statsTableBody.innerHTML = Object.values(stats).map(s => {
                    const total = s.c + s.i;
                    const rate = total > 0 ? `${((s.c/total)*100).toFixed(0)}%` : 'N/A';
                    return `<tr class="bg-white border-b"><th class="px-4 py-3 font-medium text-slate-900">${s.name}</th><td class="px-4 py-3 text-center text-green-600">${s.c}</td><td class="px-4 py-3 text-center text-red-600">${s.i}</td><td class="px-4 py-3 text-center">${rate}</td></tr>`;
                }).join('');
            }

            function getLectureStats() {
                const lectureStats = {};
                flashcards.forEach(card => {
                    if (!lectureStats[card.lecture]) {
                        lectureStats[card.lecture] = { attempts: 0, correct: 0, timestamps: [] };
                    }
                    Object.values(card.scores).forEach(dir => Object.values(dir).forEach(mode => {
                        lectureStats[card.lecture].attempts += mode.correct + mode.incorrect;
                        lectureStats[card.lecture].correct += mode.correct;
                        if (mode.lastTrained) {
                            lectureStats[card.lecture].timestamps.push(new Date(mode.lastTrained).getTime());
                        }
                    }));
                });
                return lectureStats;
            }

            function updateQuizSuggestions() {
                quizSuggestionsContainer.innerHTML = '';
                if (quizHistory.length > 0) {
                    const lastQuiz = quizHistory[0];
                    const direction = lastQuiz.direction === 'en-de' ? 'EN → DE' : 'DE → EN';
                    const repeatButtonHTML = `
                        <button data-lecture="${lastQuiz.lecture}" data-direction="${lastQuiz.direction}" data-mode="${lastQuiz.mode}" class="direct-start-btn w-full text-left p-3 border-2 border-[var(--accent-500)] rounded-lg hover:bg-slate-50">
                            <p class="font-semibold text-[var(--accent-600)]">Repeat Last Quiz</p>
                            <p class="text-sm text-slate-500">${lastQuiz.lecture} (${direction}, ${lastQuiz.mode})</p>
                        </button>
                    `;
                    quizSuggestionsContainer.innerHTML += repeatButtonHTML;
                }

                if (flashcards.length === 0) {
                     if (quizHistory.length === 0) quizSuggestionsContainer.innerHTML = '<p class="text-sm text-slate-500">Add some phrases to get smart suggestions!</p>';
                    return;
                }
                
                const stats = getLectureStats();
                const suggestions = [];

                const fewestAttempts = Object.entries(stats).sort((a, b) => a[1].attempts - b[1].attempts)[0];
                if(fewestAttempts) suggestions.push({ lecture: fewestAttempts[0], reason: `Least practiced (${fewestAttempts[1].attempts} attempts)` });

                const lowestRate = Object.entries(stats).filter(s => s[1].attempts > 0).sort((a, b) => (a[1].correct / a[1].attempts) - (b[1].correct / b[1].attempts))[0];
                if(lowestRate) suggestions.push({ lecture: lowestRate[0], reason: `Lowest success rate (${(lowestRate[1].correct / lowestRate[1].attempts * 100).toFixed(0)}%)` });

                const oldestMean = Object.entries(stats).map(([name, data]) => {
                    const meanTimestamp = data.timestamps.length > 0 ? data.timestamps.reduce((a, b) => a + b, 0) / data.timestamps.length : 0;
                    return { lecture: name, meanTimestamp };
                }).filter(s => s.meanTimestamp > 0).sort((a, b) => a.meanTimestamp - b.meanTimestamp)[0];
                if(oldestMean) suggestions.push({ lecture: oldestMean.lecture, reason: `Oldest average practice` });

                const uniqueSuggestions = [...new Map(suggestions.map(item => [item['lecture'], item])).values()].slice(0, 3);

                const suggestionsHTML = uniqueSuggestions.map(s => {
                    return `<button data-lecture="${s.lecture}" data-direction="de-en" data-mode="choice" class="direct-start-btn w-full text-left p-3 border rounded-lg hover:bg-slate-50"><p class="font-semibold">${s.lecture}</p><p class="text-sm text-slate-500">${s.reason}</p></button>`;
                }).join('');
                 quizSuggestionsContainer.innerHTML += suggestionsHTML;
                
                 if (quizSuggestionsContainer.innerHTML === '') {
                    quizSuggestionsContainer.innerHTML = '<p class="text-sm text-slate-500">Practice to get smart suggestions!</p>';
                }
            }

            quizSuggestionsContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('.direct-start-btn');
                if (btn) {
                    initiateQuiz(btn.dataset.lecture, btn.dataset.direction, btn.dataset.mode);
                }
            });
            function updateQuizLectureFilter() {
                 const lectures = [...new Set(flashcards.map(c => c.lecture))];
                 quizLectureFilter.innerHTML = '<option value="all">All Phrases</option>';
                 lectures.sort().forEach(l => quizLectureFilter.appendChild(new Option(l, l)));
            }
             // --- History Page Logic ---
            function getStarsHTML(percentage) {
                let starsHTML = '';
                if(percentage >= 95) { starsHTML = '⭐⭐⭐⭐⭐'; }
                else if (percentage >= 80) { starsHTML = '⭐⭐⭐⭐<span class="star-rating">⭐</span>'; }
                else if (percentage >= 60) { starsHTML = '⭐⭐⭐<span class="star-rating">⭐⭐</span>'; }
                else if (percentage >= 40) { starsHTML = '⭐⭐<span class="star-rating">⭐⭐⭐</span>'; }
                else { starsHTML = '⭐<span class="star-rating">⭐⭐⭐⭐</span>'; }
                return starsHTML.replace(/⭐/g, '<span class="filled">★</span>').replace(/<span class="star-rating">★<\/span>/g, '★');
            }

            function updateHistoryPage() {
                if (quizHistory.length === 0) {
                    historyListEl.innerHTML = '<p class="text-slate-500 text-sm">Your quiz history will appear here.</p>';
                    return;
                }
                historyListEl.innerHTML = quizHistory.map(item => {
                    const date = new Date(item.date).toLocaleString();
                    const direction = item.direction === 'en-de' ? 'EN → DE' : 'DE → EN';
                    const percentage = item.presented > 0 ? (item.correct / item.presented) * 100 : 0;
                    const stars = getStarsHTML(percentage);
                    return `
                        <div class="bg-slate-50 p-3 rounded-lg">
                            <div class="flex justify-between items-center">
                                <p class="font-semibold">${item.lecture}</p>
                                <div class="text-lg">${stars}</div>
                            </div>
                            <div class="flex justify-between items-center text-sm text-slate-500 mt-1">
                                <span>${direction} (${item.mode})</span>
                                <span class="font-bold">${item.correct}/${item.presented}</span>
                            </div>
                             <div class="text-xs text-slate-400 text-right mt-1">${date}</div>
                        </div>
                    `;
                }).join('');
            }

            // --- Quiz Logic ---
            function shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function getBinForQuiz(card, direction, mode) {
                const s = card.scores[direction][mode];
                const total = s.correct + s.incorrect;
                if (total === 0) return { label: 'New Phrase' };
                const rate = s.correct / total;
                if (rate < settings.binThresholds.p1 / 100) return { label: 'Needs Practice' };
                if (rate < settings.binThresholds.p2 / 100) return { label: 'Getting There' };
                if (rate < settings.binThresholds.p3 / 100) return { label: 'Good Job' };
                return { label: 'Mastering' };
            }

            function initiateQuiz(lecture, direction, mode) {
                quizSettings = { lecture, direction, mode };
                const allCardsInLecture = (lecture === 'all') ? [...flashcards] : flashcards.filter(card => card.lecture === lecture);
                if (allCardsInLecture.length < (mode === 'choice' ? 3 : 1)) {
                    showToast(`Not enough phrases in this lecture (need ${mode === 'choice' ? 3 : 1}).`, true);
                    return;
                }
                
                const bins = { 1: [], 2: [], 3: [], 4: [] };
                allCardsInLecture.forEach(card => {
                    const s = card.scores[direction][mode];
                    const total = s.correct + s.incorrect;
                    const rate = total === 0 ? -1 : s.correct / total;
                    if (rate < settings.binThresholds.p1 / 100) bins[1].push(card);
                    else if (rate < settings.binThresholds.p2 / 100) bins[2].push(card);
                    else if (rate < settings.binThresholds.p3 / 100) bins[3].push(card);
                    else bins[4].push(card);
                });

                quizQueue = [
                    ...shuffle(bins[1]), ...shuffle(bins[2]),
                    ...shuffle(bins[3]), ...shuffle(bins[4])
                ];

                quizSessionStats = { correct: 0, presented: 0, initialQueueLength: quizQueue.length };
                hideModal(quizSetupView);
                showModal(quizSection);
                loadNextQuestion();
            }

            startQuizBtn.addEventListener('click', () => {
                const lecture = quizLectureFilter.value;
                const direction = document.querySelector('input[name="quiz-direction"]:checked').value;
                const mode = document.querySelector('input[name="quiz-mode"]:checked').value;
                initiateQuiz(lecture, direction, mode);
            });

            endQuizBtn.addEventListener('click', () => {
                clearTimeout(autoAdvanceTimer);
                hideModal(quizSection);
                showQuizFeedback();
            });

            function loadNextQuestion() {
                clearTimeout(autoAdvanceTimer);
                if(quizQueue.length === 0 || quizSessionStats.presented >= settings.maxQuestions) {
                    endQuizBtn.click();
                    return;
                }

                currentCard = quizQueue.shift();
                quizSessionStats.presented++;
                
                const { direction, mode } = quizSettings;
                const question = direction === 'en-de' ? currentCard.english : currentCard.german;
                const answer = direction === 'en-de' ? currentCard.german : currentCard.english;
                currentCard.question = question;
                currentCard.answer = answer;

                // Update Progress Bar & Reason
                const totalQuestions = Math.min(quizSessionStats.initialQueueLength, settings.maxQuestions);
                const progressPercent = (quizSessionStats.presented / totalQuestions) * 100;
                progressBar.style.width = `${progressPercent}%`;
                progressText.textContent = `${quizSessionStats.presented} / ${totalQuestions}`;

                if (currentCard.isRepeat) {
                    quizReason.textContent = 'Repeating a missed phrase';
                    delete currentCard.isRepeat; // Consume the flag
                } else {
                    const bin = getBinForQuiz(currentCard, quizSettings.direction, quizSettings.mode);
                    quizReason.textContent = `Reason: ${bin.label}`;
                }

                if (direction === 'en-de') {
                    setTimeout(() => speak(question, 'en-US'), 100); 
                }

                quizWord.innerHTML = `<b>${question}</b>`;
                speakQuestionBtn.classList.toggle('hidden', direction !== 'en-de');
                quizPromptText.textContent = `What is the ${direction === 'en-de' ? 'German' : 'English'} translation?`;

                resultArea.classList.add('hidden');
                quizInputArea.classList.remove('hidden');

                if (mode === 'typing') {
                    typingInputContainer.classList.remove('hidden'); choiceInputContainer.classList.add('hidden'); speechInputContainer.classList.add('hidden');
                    answerInput.value = '';
                    answerInput.focus();
                } else if (mode === 'choice') {
                    typingInputContainer.classList.add('hidden'); choiceInputContainer.classList.remove('hidden'); speechInputContainer.classList.add('hidden');
                    let options = [answer];
                    const allAnswers = (quizSettings.lecture === 'all' ? flashcards : flashcards.filter(c => c.lecture === quizSettings.lecture))
                                     .map(c => direction === 'en-de' ? c.german : c.english);
                    const wrongAnswers = shuffle(allAnswers.filter(a => a !== answer));
                    while (options.length < 3 && wrongAnswers.length > 0) {
                        options.push(wrongAnswers.pop());
                    }
                    choiceInputContainer.innerHTML = shuffle(options).map(opt => `<button class="choice-btn w-full text-left p-3 border rounded-lg hover:bg-slate-100">${opt}</button>`).join('');
                } else { // speech
                    typingInputContainer.classList.add('hidden'); choiceInputContainer.classList.add('hidden'); speechInputContainer.classList.remove('hidden');
                }
            }
            choiceInputContainer.addEventListener('click', e => { if(e.target.classList.contains('choice-btn')) checkAnswer(e.target.textContent); });
            function checkAnswer(userAnswer) {
                clearTimeout(autoAdvanceTimer);
                const isCorrect = userAnswer.trim().toLowerCase() === currentCard.answer.toLowerCase();
                
                const cardInDb = flashcards.find(c => c.id === currentCard.id);
                if (cardInDb) {
                    const s = cardInDb.scores[quizSettings.direction][quizSettings.mode];
                    if(isCorrect) {
                        s.correct++;
                        s.lastTrained = new Date().toISOString();
                        quizSessionStats.correct++;
                    } else {
                        s.incorrect++;
                        const repeatCard = { ...currentCard, isRepeat: true };
                        quizQueue.splice(settings.repeatAfter - 1, 0, repeatCard);
                    }
                    saveFlashcards();
                }

                resultArea.classList.remove('hidden');
                quizInputArea.classList.add('hidden');
                resultText.textContent = isCorrect ? 'Correct!' : 'Not quite!';
                resultArea.className = `text-center mt-4 p-4 rounded-lg ${isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
                correctAnswerText.innerHTML = `The answer is <b>"${currentCard.answer}"</b>.`;
                speakBtn.dataset.speakEnglish = currentCard.english;

                const startTimer = () => {
                    const delay = isCorrect ? settings.autoAdvanceCorrect * 1000 : settings.autoAdvanceWrong * 1000;
                    if(delay > 0) {
                       autoAdvanceTimer = setTimeout(loadNextQuestion, delay);
                    }
                };

                if(isCorrect && quizSettings.direction === 'de-en'){
                    speak(currentCard.english, 'en-US', startTimer);
                } else {
                    startTimer();
                }
            }
            nextQuestionBtn.addEventListener('click', loadNextQuestion);
            checkAnswerBtn.addEventListener('click', () => checkAnswer(answerInput.value));
            answerInput.addEventListener('keyup', (e) => { if (e.key === 'Enter' && !resultArea.classList.contains('hidden')) nextQuestionBtn.click(); else if (e.key === 'Enter') checkAnswerBtn.click(); });
            speakBtn.addEventListener('click', (e) => speak(e.currentTarget.dataset.speakEnglish, 'en-US'));
            speakQuestionBtn.addEventListener('click', () => speak(currentCard.question, 'en-US'));

            // --- Quiz Feedback Logic ---
            function showQuizFeedback() {
                const { correct, presented } = quizSessionStats;
                
                const historyEntry = {
                    date: new Date().toISOString(),
                    lecture: quizSettings.lecture,
                    direction: quizSettings.direction,
                    mode: quizSettings.mode,
                    correct: correct,
                    presented: presented,
                    id: Date.now()
                };
                quizHistory.unshift(historyEntry);
                saveQuizHistory();

                const percentage = presented > 0 ? (correct / presented) * 100 : 0;
                feedbackCorrect.textContent = correct;
                feedbackTotal.textContent = presented;
                
                feedbackStars.innerHTML = getStarsHTML(percentage);
                let message = '';
                if(percentage >= 95) { message = 'Outstanding! You\'re a vocabulary superstar!'; }
                else if (percentage >= 80) { message = 'Great Job! You have a strong command of these.'; }
                else if (percentage >= 60) { message = 'Good Effort! Keep it up!'; }
                else if (percentage >= 40) { message = 'Nice Try! Practice makes perfect.'; }
                else { message = 'Keep Studying! Every attempt helps.'; }
                feedbackMessage.textContent = message;
                showModal(quizFeedbackView);
            }

            // --- Settings Logic ---
            function loadSettings() {
                const savedSettings = localStorage.getItem('settings');
                let tempSettings = savedSettings ? JSON.parse(savedSettings) : {};
                
                // Set defaults and handle migration from old settings structure
                settings = {
                    theme: tempSettings.theme || 'blue',
                    autoAdvanceCorrect: tempSettings.autoAdvanceCorrect ?? 0,
                    autoAdvanceWrong: tempSettings.autoAdvanceWrong ?? 3,
                    maxQuestions: tempSettings.maxQuestions || 20,
                    repeatAfter: tempSettings.repeatAfter || 5,
                    binThresholds: tempSettings.binThresholds || { p1: 25, p2: 50, p3: 75 }
                };

                applySettings();
            }
            function saveSettings() {
                localStorage.setItem('settings', JSON.stringify(settings));
            }
            function applySettings() {
                document.body.classList.remove('theme-blue', 'theme-green');
                document.body.classList.add(`theme-${settings.theme}`);
            }
            function updateSettingsPage() {
                document.querySelector(`input[name="theme"][value="${settings.theme}"]`).checked = true;
                document.getElementById('auto-advance-correct-time').value = settings.autoAdvanceCorrect;
                document.getElementById('auto-advance-wrong-time').value = settings.autoAdvanceWrong;
                document.getElementById('max-quiz-questions').value = settings.maxQuestions;
                document.getElementById('repeat-after-input').value = settings.repeatAfter;
                
                bin1Slider.value = settings.binThresholds.p1;
                bin2Slider.value = settings.binThresholds.p2;
                bin3Slider.value = settings.binThresholds.p3;
                updateBinSliderLabelsAndConstraints();
            }
            
            function updateBinSliderLabelsAndConstraints(){
                const p1 = parseInt(bin1Slider.value, 10);
                const p2 = parseInt(bin2Slider.value, 10);
                const p3 = parseInt(bin3Slider.value, 10);

                bin1Label.textContent = `0-${p1}%`;
                bin2Label.textContent = `${p1}-${p2}%`;
                bin3Label.textContent = `${p2}-${p3}%`;
                // Adjust constraints to prevent overlap
                bin2Slider.min = p1 + 1;
                bin3Slider.min = p2 + 1;
                bin1Slider.max = p2 - 1;
                bin2Slider.max = p3 - 1;
            }

            [bin1Slider, bin2Slider, bin3Slider].forEach(slider => {
                slider.addEventListener('input', updateBinSliderLabelsAndConstraints);
            });

            saveSettingsBtn.addEventListener('click', () => {
                const newTheme = document.querySelector('input[name="theme"]:checked').value;
                settings.theme = newTheme;
                const newCorrectTime = parseInt(document.getElementById('auto-advance-correct-time').value, 10);
                const newWrongTime = parseInt(document.getElementById('auto-advance-wrong-time').value, 10);

                settings.autoAdvanceCorrect = isNaN(newCorrectTime) ? 0 : newCorrectTime;
                settings.autoAdvanceWrong = isNaN(newWrongTime) ? 3 : newWrongTime;
                settings.maxQuestions = parseInt(document.getElementById('max-quiz-questions').value, 10) || 20;
                settings.repeatAfter = parseInt(document.getElementById('repeat-after-input').value, 10) || 5;
                settings.binThresholds.p1 = parseInt(bin1Slider.value, 10);
                settings.binThresholds.p2 = parseInt(bin2Slider.value, 10);
                settings.binThresholds.p3 = parseInt(bin3Slider.value, 10);
                
                saveSettings();
                applySettings();
                showToast('Settings saved!');
                showPage('main-page');
            });

            // --- Initial Load ---
            loadSettings();
            loadData();
            showPage('main-page');
        });
    </script>
</body>
</html>

